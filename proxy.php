<?php
require 'vendor/autoload.php';

use GuzzleHttp\Pool;
use GuzzleHttp\Client;
use GuzzleHttp\Psr7\Request;

$proxyList = [
    '36.91.98.115:8181',
    '94.231.192.38:8080',
    '46.17.63.166:18888',
    '103.76.190.37:31756',
    '66.235.200.21:80',
    '114.103.88.87:8089',
    '102.223.20.217:80',
    '103.206.208.135:55443',
    '8.210.69.108:443',
    '45.14.174.0:80',
    '165.16.27.29:1981',
    '154.66.108.52:3629',
    '1.179.144.41:8080',
    '186.24.9.116:999',
    '40.83.102.86:80',
    '102.68.128.214:8080',
    '141.101.120.44:80',
    '45.8.105.83:80',
    '46.40.6.198:7777',
    '66.29.128.245:62551',
    '41.190.154.234:33333',
    '120.46.197.14:7777',
    '162.159.248.147:80',
    '191.102.254.12:8085',
    '184.170.248.5:4145',
    '190.57.245.250:8080',
    '115.127.32.22:1088',
    '41.215.85.74:8080',
    '5.135.136.60:9090',
    '74.208.219.109:3128',
    '195.178.56.37:8080',
    '119.13.103.211:8085',
    '103.210.161.198:8998',
    '167.71.212.154:80',
    '103.149.194.9:32650',
    '102.66.4.214:33333',
    '182.253.73.130:8080',
    '172.67.74.230:80',
    '107.1.93.211:80',
    '212.33.248.45:1080',
    '206.62.165.42:999',
    '45.70.238.182:999',
    '1.0.205.87:8080',
    '129.205.246.105:5678',
    '194.181.82.37:7497',
    '111.40.116.212:9091',
    '103.75.117.79:80',
    '92.247.12.136:9510',
    '109.201.13.187:8080',
    '51.91.144.39:59191',
    '46.105.44.29:35923',
    '50.168.163.178:80',
    '103.127.204.116:27416',
    '45.226.205.11:999',
    '80.240.202.218:8080',
    '203.30.190.93:80',
    '41.33.66.228:1981',
    '104.19.99.95:80',
    '182.52.63.95:4153',
    '103.176.108.105:1414',
    '187.1.57.206:20183',
    '78.140.195.66:3629',
    '203.190.113.146:8077',
    '193.141.65.48:8975',
    '198.11.175.180:8095',
    '50.96.204.4:18351',
    '23.106.49.197:8080',
    '115.160.160.38:3128',
    '3.24.58.156:3128',
    '144.126.212.235:60385',
    '173.245.252.206:54321',
    '8.209.243.173:1234',
    '194.233.78.142:41215',
    '119.18.158.130:4153',
    '203.32.120.115:80',
    '116.118.98.26:5678',
    '165.227.225.102:8745',
    '78.46.225.110:7826',
    '154.23.186.113:3128',
    '202.162.105.202:80',
    '159.138.252.45:2080',
    '45.186.60.10:8085',
    '177.87.250.23:999',
    '203.30.190.30:80',
    '182.237.188.42:80',
    '192.198.61.138:8080',
    '202.166.164.115:5678',
    '188.114.97.18:80',
    '45.228.235.25:999',
    '50.174.7.155:80',
    '0.0.0.0:80',
    '50.175.31.250:80',
    '222.190.173.102:8089',
    '144.76.75.25:4444',
    '203.13.32.156:80',
    '200.29.237.107:5678',
    '185.118.155.202:8080',
    '190.93.246.26:80',
    '200.41.60.33:4153',
    '36.95.35.49:5678',
    '45.12.31.18:80',
    '45.131.4.223:80',
    '47.96.42.206:80',
    '172.67.43.184:80',
    '47.254.158.115:9992',
    '180.211.161.110:8080',
    '203.32.121.160:80',
    '85.159.88.220:8111',
    '80.80.167.241:10801',
    '37.120.189.106:80',
    '183.165.248.179:8089',
    '85.236.4.51:8080',
    '117.160.250.134:80',
    '200.34.215.1:4153',
    '193.151.130.114:8086',
    '172.67.88.21:80',
    '103.114.35.31:3629',
    '49.0.250.196:502',
    '88.99.10.252:1080',
    '187.188.171.73:6969',
    '94.74.80.88:1234',
    '149.202.172.113:80',
    '183.164.254.8:4216',
    '50.204.219.226:80',
    '172.67.27.160:80',
    '172.67.179.197:80',
    '114.102.44.197:8089',
    '105.235.219.154:8080',
    '152.69.193.140:3128',
    '34.86.196.77:8585',
    '193.149.185.17:33081',
    '103.15.80.85:3128',
    '41.77.188.131:80',
    '47.74.64.65:2080',
    '124.70.78.157:8000',
    '209.58.186.197:8118',
    '75.119.203.208:23456',
    '159.192.138.170:8080',
    '104.25.0.13:80',
    '45.225.184.177:999',
    '196.20.125.129:8083',
    '43.251.119.79:45787',
    '47.254.47.61:443',
    '186.126.17.219:1080',
    '105.19.63.217:9812',
    '172.67.182.94:80',
    '195.201.226.34:4000',
    '5.189.129.126:30022',
    '155.50.250.163:3128',
    '49.229.32.166:4153',
    '66.29.128.243:15726',
    '172.67.70.71:80',
    '115.144.8.91:80',
    '81.12.44.197:3129',
    '8.213.128.90:8118',
    '45.184.155.6:999',
    '43.255.113.232:84',
    '189.113.14.243:80',
    '203.23.103.66:80',
    '54.177.115.163:8080',
    '119.237.43.106:80',
    '50.219.106.81:80',
    '209.159.153.19:36438',
    '103.157.224.1:5678',
    '176.97.80.48:5678',
    '212.200.161.241:5678',
    '37.237.134.179:32650',
    '103.127.1.130:80',
    '49.0.246.130:19',
    '124.158.167.242:8080',
    '47.243.50.83:1024',
    '176.235.139.37:10001',
    '211.138.6.37:9091',
    '103.242.119.88:80',
    '104.19.174.180:80',
    '141.101.123.158:80',
    '23.227.38.232:80',
    '212.38.166.66:3128',
    '197.251.236.227:5678',
    '217.115.213.187:4145',
    '165.22.40.154:3128',
    '194.44.93.102:3128',
    '50.221.74.130:80',
    '185.86.82.74:8080',
    '103.60.214.18:51754',
    '45.85.119.154:80',
    '120.238.19.2:1080',
    '103.120.38.232:5678',
    '115.127.87.245:8674',
    '119.13.111.169:55443',
    '141.101.122.1:80',
    '95.158.174.111:8080',
    '193.239.86.249:3128',
    '68.1.210.189:4145',
    '75.119.206.18:23456',
    '41.33.145.219:1981',
    '103.42.28.27:45787',
    '101.65.134.70:8085',
    '103.158.253.130:8080',
    '50.174.41.66:80',
    '60.12.168.114:9002',
    '185.162.231.221:80',
    '36.64.202.57:33333',
    '190.120.249.213:8086',
    '111.40.124.221:9091',
    '193.169.4.184:10801',
    '80.122.170.182:4153',
    '217.172.122.14:8080',
    '37.148.211.79:3128',
    '107.152.98.5:4145',
    '172.64.101.146:80',
    '177.73.182.1:4145',
    '83.171.114.92:45822',
    '162.247.243.167:80',
    '50.206.111.89:80',
    '92.118.132.125:8080',
    '185.162.229.161:80',
    '213.210.67.186:3629',
    '145.239.17.189:8123',
    '172.67.250.212:80',
    '89.249.65.191:3128',
    '104.20.189.55:80',
    '49.0.253.51:3132',
    '213.32.75.88:9300',
    '64.225.8.203:10000',
    '149.50.230.154:8080',
    '43.132.184.228:8181',
    '85.117.56.174:9801',
    '80.232.245.122:8080',
    '104.18.208.0:80',
    '45.175.237.20:999',
    '185.191.236.162:3128',
    '87.76.1.251:8080',
    '45.196.148.117:5432',
    '50.217.153.78:80',
    '49.48.147.64:8080',
    '212.83.143.191:61310',
    '221.141.158.183:80',
    '185.105.102.189:80',
    '173.249.46.92:3128',
    '32.223.6.94:80',
    '36.92.36.42:4153',
    '50.218.57.69:80',
    '221.151.181.101:8000',
    '47.243.50.83:8082',
    '203.34.28.89:80',
    '160.153.0.30:80',
    '203.34.28.50:80',
    '212.200.149.242:5678',
    '58.234.116.197:8193',
    '185.162.229.220:80',
    '50.174.145.11:80',
    '8.208.89.32:1234',
    '172.67.182.97:80',
    '103.133.221.251:80',
    '212.129.15.88:8080',
    '95.66.138.21:8880',
    '50.218.57.64:80',
    '137.184.71.106:62295',
    '202.162.105.202:8000',
    '93.149.136.74:80',
    '185.7.212.168:1234',
    '94.141.240.36:60501',
    '177.73.68.150:8080',
    '181.115.69.11:999',
    '104.20.75.53:80',
    '201.184.63.218:8080',
    '181.28.111.161:8080',
    '103.155.197.49:8080',
    '115.144.79.198:23500',
    '115.144.16.230:10501',
    '176.98.87.123:8080',
    '213.6.131.62:5678',
    '172.67.90.190:80',
    '197.232.48.155:32650',
    '203.23.106.118:80',
    '125.26.4.221:8080',
    '69.163.160.191:28640',
    '185.105.230.45:3128',
    '50.200.12.85:80',
    '154.236.191.51:1981',
    '203.24.108.161:80',
    '96.113.159.162:80',
    '114.231.41.233:8089',
    '188.32.65.49:81',
    '94.26.241.120:8080',
    '50.173.140.145:80',
    '8.209.64.208:8999',
    '172.67.0.66:80',
    '47.74.64.65:6666',
    '203.30.188.176:80',
    '103.83.232.122:80',
    '113.110.23.229:44844',
    '122.10.101.145:3333',
    '20.204.212.76:3129',
    '104.20.75.36:80',
    '123.193.231.167:80',
    '172.67.222.36:80',
    '87.254.171.208:3333',
    '188.114.96.66:80',
    '203.32.120.38:80',
    '103.91.220.226:80',
    '172.67.88.159:80',
    '138.68.109.12:22124',
    '81.96.149.127:8118',
    '3.90.11.60:8443',
];

$guzzle = new Client();

$requests = function ($proxyList) {
    foreach ($proxyList as $proxy) {
        yield new Request('GET', 'http://www.bing.com', ['proxy' => $proxy, 'timeout' => 10]);
    }
};

$results = [];

$pool = new Pool($guzzle, $requests($proxyList), [
    'concurrency' => 100, // Jumlah request paralel maksimum
    'fulfilled' => function ($response, $index) use (&$results, $proxyList) {
        $proxy = $proxyList[$index];
        if ($response->getStatusCode() === 200) {
            $results[] = ['proxy' => $proxy, 'status' => 'Success'];
        } else {
            $results[] = ['proxy' => $proxy, 'status' => 'Error', 'error_message' => 'HTTP Error'];
        }
        echo "Checked proxy: $proxy - Success\n"; // Tampilkan di terminal
    },
    'rejected' => function ($reason, $index) use (&$results, $proxyList) {
        $proxy = $proxyList[$index];
        $results[] = ['proxy' => $proxy, 'status' => 'Error', 'error_message' => $reason->getMessage()];
        echo "Checked proxy: $proxy - Error: " . $reason->getMessage() . "\n"; // Tampilkan di terminal
    },
]);

$promise = $pool->promise();
$promise->wait();

$workingProxies = [];

foreach ($results as $result) {
    if ($result['status'] === 'Success') {
        $workingProxies[] = $result['proxy'];
    }
}

if (!empty($workingProxies)) {
    $proxyFile = fopen("proxy.txt", "w");
    fwrite($proxyFile, implode("\n", $workingProxies));
    fclose($proxyFile);
    echo "Working proxies saved to proxy.txt\n";
} else {
    echo "No working proxies found.\n";
}
